<!DOCTYPE html>
<html dir="ltr" mozdisallowselectionprint>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="google" content="notranslate">
    <title>PDF.js viewer</title>
    
    <!-- PDF.js resources -->
    <link rel="resource" type="application/l10n" href="locale/locale.json">
    <link rel="stylesheet" href="viewer.css">
    
    <style>
      /* Disable text selection */
      body, #viewerContainer, .pdfViewer {
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
      }
    
      /* Remove download & print buttons */
      #downloadButton,
      #printButton,
      #secondaryDownload,
      #secondaryPrint {
        display: none !important;
      }
    
      /* Hide editing tools */
      #editorModeButtons,
      #editorUndoBar,
      #editorSignature,
      #editorHighlight,
      #editorFreeText,
      #editorInk,
      #editorStamp {
        display: none !important;
      }
    
      /* Hide secondary tools that allow saving/editing */
      #secondaryToolbar .toolbarButton[data-l10n-id="pdfjs-open-file-button"],
      #secondaryToolbar .toolbarButton[data-l10n-id="pdfjs-save-button"],
      #secondaryToolbar .toolbarButton[data-l10n-id="pdfjs-print-button"] {
        display: none !important;
      }
      
      /* Improved sidebar thumbnails */
      #thumbnailView {
        padding: 10px 0;
      }
      .thumbnail {
        margin: 5px auto;
        border: 1px solid #ddd;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s;
      }
      .thumbnail:hover {
        transform: scale(1.03);
      }
      .thumbnail.selected {
        border-color: #0060df;
      }
    </style>
  </head>

  <body tabindex="0">
    <div id="outerContainer">

      <div id="sidebarContainer">
        <div id="toolbarSidebar" class="toolbarHorizontalGroup">
          <div id="toolbarSidebarLeft">
            <div id="sidebarViewButtons" class="toolbarHorizontalGroup toggled" role="radiogroup">
              <button id="viewThumbnail" class="toolbarButton toggled" type="button" tabindex="0" data-l10n-id="pdfjs-thumbs-button" role="radio" aria-checked="true" aria-controls="thumbnailView">
                 <span data-l10n-id="pdfjs-thumbs-button-label"></span>
              </button>
              <button id="viewOutline" class="toolbarButton" type="button" tabindex="0" data-l10n-id="pdfjs-document-outline-button" role="radio" aria-checked="false" aria-controls="outlineView">
                 <span data-l10n-id="pdfjs-document-outline-button-label"></span>
              </button>
            </div>
          </div>
        </div>
        <div id="sidebarContent">
          <div id="thumbnailView"></div>
          <div id="outlineView" class="hidden"></div>
        </div>
        <div id="sidebarResizer"></div>
      </div>  <!-- sidebarContainer -->

      <div id="mainContainer">
        <div class="toolbar">
          <div id="toolbarContainer">
            <div id="toolbarViewer" class="toolbarHorizontalGroup">
              <div id="toolbarViewerLeft" class="toolbarHorizontalGroup">
                <button id="sidebarToggleButton" class="toolbarButton" type="button" tabindex="0" data-l10n-id="pdfjs-toggle-sidebar-button" aria-expanded="false" aria-haspopup="true" aria-controls="sidebarContainer">
                  <span data-l10n-id="pdfjs-toggle-sidebar-button-label"></span>
                </button>
                <div class="toolbarButtonSpacer"></div>
                <div class="toolbarHorizontalGroup hiddenSmallView">
                  <button class="toolbarButton" type="button" id="previous" tabindex="0" data-l10n-id="pdfjs-previous-button">
                    <span data-l10n-id="pdfjs-previous-button-label"></span>
                  </button>
                  <div class="splitToolbarButtonSeparator"></div>
                  <button class="toolbarButton" type="button" id="next" tabindex="0" data-l10n-id="pdfjs-next-button">
                    <span data-l10n-id="pdfjs-next-button-label"></span>
                  </button>
                </div>
                <div class="toolbarHorizontalGroup">
                  <span class="loadingInput start toolbarHorizontalGroup">
                    <input type="number" id="pageNumber" class="toolbarField" value="1" min="1" tabindex="0" data-l10n-id="pdfjs-page-input" autocomplete="off">
                  </span>
                  <span id="numPages" class="toolbarLabel"></span>
                </div>
              </div>
              <div id="toolbarViewerMiddle" class="toolbarHorizontalGroup">
                <div class="toolbarHorizontalGroup">
                  <button id="zoomOutButton" class="toolbarButton" type="button" tabindex="0" data-l10n-id="pdfjs-zoom-out-button">
                    <span data-l10n-id="pdfjs-zoom-out-button-label"></span>
                  </button>
                  <div class="splitToolbarButtonSeparator"></div>
                  <button id="zoomInButton" class="toolbarButton" type="button" tabindex="0" data-l10n-id="pdfjs-zoom-in-button">
                    <span data-l10n-id="pdfjs-zoom-in-button-label"></span>
                  </button>
                </div>
                <span id="scaleSelectContainer" class="dropdownToolbarButton">
                  <select id="scaleSelect" tabindex="0" data-l10n-id="pdfjs-zoom-select">
                    <option id="pageAutoOption" value="auto" selected="selected" data-l10n-id="pdfjs-page-scale-auto"></option>
                    <option id="pageActualOption" value="page-actual" data-l10n-id="pdfjs-page-scale-actual"></option>
                    <option id="pageFitOption" value="page-fit" data-l10n-id="pdfjs-page-scale-fit"></option>
                    <option id="pageWidthOption" value="page-width" data-l10n-id="pdfjs-page-scale-width"></option>
                    <option value="0.5" data-l10n-id="pdfjs-page-scale-percent" data-l10n-args='{ "scale": 50 }'></option>
                    <option value="0.75" data-l10n-id="pdfjs-page-scale-percent" data-l10n-args='{ "scale": 75 }'></option>
                    <option value="1" data-l10n-id="pdfjs-page-scale-percent" data-l10n-args='{ "scale": 100 }'></option>
                    <option value="1.25" data-l10n-id="pdfjs-page-scale-percent" data-l10n-args='{ "scale": 125 }'></option>
                    <option value="1.5" data-l10n-id="pdfjs-page-scale-percent" data-l10n-args='{ "scale": 150 }'></option>
                    <option value="2" data-l10n-id="pdfjs-page-scale-percent" data-l10n-args='{ "scale": 200 }'></option>
                  </select>
                </span>
              </div>
            </div>
          </div>
        </div>

        <div id="viewerContainer" tabindex="0">
          <div id="viewer" class="pdfViewer"></div>
        </div>
      </div> <!-- mainContainer -->
    </div> <!-- outerContainer -->

    <script src="../build/pdf.mjs" type="module"></script>
    <script src="viewer.mjs" type="module"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Security measures
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
          if ((e.ctrlKey || e.metaKey) && ['p', 's', 'o'].includes(e.key.toLowerCase())) {
            e.preventDefault();
          }
        });

        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = '../build/pdf.worker.mjs';
        
        // Get PDF path from URL
        const urlParams = new URLSearchParams(window.location.search);
        let pdfPath = urlParams.get('file');
        
        if (!pdfPath) {
          console.error('No PDF specified in URL');
          alert('Please specify a PDF file using ?file= parameter');
          return;
        }

        // Clean path - remove any proxy wrappers and domain prefixes
        const cleanPath = (path) => {
          try {
            // If it's a URL to our own proxy, extract the real path
            if (path.includes('webserver-zpgc.onrender.com/file?path=')) {
              const url = new URL(path);
              return cleanPath(url.searchParams.get('path'));
            }
            // Remove domain prefix if present
            return path.replace(/^https?:\/\/[^/]+\/webapp\/MobileApp\//, '');
          } catch {
            return path; // Not a URL, return as-is
          }
        };

        const finalPath = cleanPath(pdfPath);
        console.log('Loading PDF from path:', finalPath);
        
        // Current scale state
        let currentScale = 1.0;
        const SCALE_INCREMENT = 0.25;
        const MIN_SCALE = 0.25;
        const MAX_SCALE = 3.0;
        
        // Load PDF through proxy
        const loadingTask = pdfjsLib.getDocument({
          url: `/file?path=${encodeURIComponent(finalPath)}`,
          disableAutoFetch: true,
          disableStream: true,
          cMapUrl: '../web/cmaps/',
          cMapPacked: true
        });

        let pdfDocument = null;
        let pdfViewer = null;
        
        loadingTask.promise.then(function(doc) {
          pdfDocument = doc;
          
          // Set total page count
          document.getElementById('numPages').textContent = pdfDocument.numPages;
          
          // Initialize viewer
          pdfViewer = new pdfjsViewer.PDFViewer({
            container: document.getElementById('viewerContainer'),
            viewer: document.getElementById('viewer')
          });
          
          // Link the viewer and document
          pdfViewer.setDocument(pdfDocument);
          
          // Set initial scale
          pdfViewer.currentScaleValue = 'auto';
          
          // Render thumbnails in sidebar
          renderThumbnails();
          
          // Handle page changes
          document.getElementById('pageNumber').addEventListener('change', function() {
            pdfViewer.currentPageNumber = parseInt(this.value);
          });
          
          // Handle zoom controls
          document.getElementById('zoomInButton').addEventListener('click', zoomIn);
          document.getElementById('zoomOutButton').addEventListener('click', zoomOut);
          document.getElementById('scaleSelect').addEventListener('change', function() {
            pdfViewer.currentScaleValue = this.value;
          });
          
          // Update page number when page changes
          pdfViewer.eventBus.on('pagechanging', function(evt) {
            document.getElementById('pageNumber').value = evt.pageNumber;
            updateThumbnailSelection(evt.pageNumber);
          });
          
        }).catch(function(error) {
          console.error('Error loading PDF:', error);
          alert('Failed to load PDF. Please check the path and try again.\nError: ' + error.message);
        });

        // Zoom functions
        function zoomIn() {
          currentScale = Math.min(MAX_SCALE, currentScale + SCALE_INCREMENT);
          pdfViewer.currentScaleValue = currentScale;
          updateScaleSelect(currentScale);
        }
        
        function zoomOut() {
          currentScale = Math.max(MIN_SCALE, currentScale - SCALE_INCREMENT);
          pdfViewer.currentScaleValue = currentScale;
          updateScaleSelect(currentScale);
        }
        
        function updateScaleSelect(scale) {
          const select = document.getElementById('scaleSelect');
          const customOption = document.getElementById('customScaleOption');
          
          // Check if scale matches a predefined option
          for (let i = 0; i < select.options.length; i++) {
            if (parseFloat(select.options[i].value) === scale) {
              select.selectedIndex = i;
              return;
            }
          }
          
          // No match found, use custom option
          customOption.value = scale;
          customOption.textContent = Math.round(scale * 100) + '%';
          customOption.hidden = false;
          customOption.disabled = false;
          select.selectedIndex = select.options.length - 1;
        }
        
        // Render thumbnails in sidebar
        function renderThumbnails() {
          const thumbnailView = document.getElementById('thumbnailView');
          
          for (let i = 1; i <= pdfDocument.numPages; i++) {
            pdfDocument.getPage(i).then(function(page) {
              const viewport = page.getViewport({ scale: 0.2 });
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              
              const renderContext = {
                canvasContext: context,
                viewport: viewport
              };
              
              const thumbnailDiv = document.createElement('div');
              thumbnailDiv.className = 'thumbnail';
              thumbnailDiv.setAttribute('data-page-number', i);
              
              // Add click handler to navigate to page
              thumbnailDiv.addEventListener('click', function() {
                pdfViewer.currentPageNumber = i;
              });
              
              thumbnailDiv.appendChild(canvas);
              thumbnailView.appendChild(thumbnailDiv);
              
              return page.render(renderContext);
            });
          }
        }
        
        // Update selected thumbnail
        function updateThumbnailSelection(pageNumber) {
          const thumbnails = document.querySelectorAll('.thumbnail');
          thumbnails.forEach(thumb => {
            if (parseInt(thumb.getAttribute('data-page-number')) === pageNumber) {
              thumb.classList.add('selected');
            } else {
              thumb.classList.remove('selected');
            }
          });
        }
        
        // Block canvas interactions
        function blockCanvasInteractions() {
          document.querySelectorAll('#viewer canvas').forEach(canvas => {
            canvas.addEventListener('mousedown', e => {
              if (e.button === 0) {
                e.preventDefault();
                e.stopPropagation();
              }
            }, true);
          });
        }
        
        // Initial blocking and periodic checks
        blockCanvasInteractions();
        setInterval(blockCanvasInteractions, 1000);
      });
    </script>
  </body>
</html>
