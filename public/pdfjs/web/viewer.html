<!DOCTYPE html>
<!--
Copyright 2012 Mozilla Foundation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html dir="ltr" mozdisallowselectionprint>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="google" content="notranslate">
    <title>PDF.js viewer</title>
    
    <!-- PDF.js resources -->
    <link rel="resource" type="application/l10n" href="locale/locale.json">
    <script src="../build/pdf.mjs" type="module"></script>
    <link rel="stylesheet" href="viewer.css">
    <script src="viewer.mjs" type="module"></script>

    <style>
      /* Disable text selection */
      body, #viewerContainer, .pdfViewer {
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
      }
    
      /* Remove download & print buttons */
      #downloadButton,
      #printButton,
      #secondaryDownload,
      #secondaryPrint {
        display: none !important;
      }
    
      /* Hide editing tools */
      #editorModeButtons,
      #editorUndoBar,
      #editorSignature,
      #editorHighlight,
      #editorFreeText,
      #editorInk,
      #editorStamp {
        display: none !important;
      }
    
      /* Hide secondary tools that allow saving/editing */
      #secondaryToolbar .toolbarButton[data-l10n-id="pdfjs-open-file-button"],
      #secondaryToolbar .toolbarButton[data-l10n-id="pdfjs-save-button"],
      #secondaryToolbar .toolbarButton[data-l10n-id="pdfjs-print-button"] {
        display: none !important;
      }
    </style>
  
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Security: Disable print/download buttons
        document.getElementById("printButton")?.remove();
        document.getElementById("downloadButton")?.remove();
        
        // Disable left-click
        document.addEventListener('mousedown', function(e) {
          if (e.button === 0) e.preventDefault();
        }, true);

        // Disable right-click context menu
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        // Disable keyboard shortcuts (Ctrl+S, Ctrl+P, etc.)
        document.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && ['p', 's', 'o'].includes(e.key.toLowerCase())) {
            e.preventDefault();
          }
        });

        // Get PDF path from URL
        const urlParams = new URLSearchParams(window.location.search);
        let pdfPath = urlParams.get('file');
        
        // If no PDF specified, show error
        if (!pdfPath) {
          console.error("No PDF specified in URL (use ?file=path/to/file.pdf)");
          return;
        }

        // Remove any domain prefixes if present
        pdfPath = pdfPath.replace(/^https?:\/\/[^/]+\/webapp\/MobileApp\//, '');
        
        // Load PDF through proxy
        const loadingTask = pdfjsLib.getDocument({
          url: `/file?path=${encodeURIComponent(pdfPath)}`,
          disableAutoFetch: true,
          disableStream: true,
          cMapUrl: '../web/cmaps/',
          cMapPacked: true
        });

        loadingTask.promise.then(pdf => {
          console.log("PDF loaded successfully");
          // PDF.js will auto-render the document
        }).catch(err => {
          console.error("PDF load error:", err);
          alert("Failed to load PDF. Please check the console for details.");
        });
      });
    </script>
  </head>

  <body tabindex="0">
    <div id="outerContainer">
      <!-- [Rest of the original HTML structure remains exactly the same] -->
      <div id="sidebarContainer">
        <!-- ... sidebar content ... -->
      </div>

      <div id="mainContainer">
        <!-- ... toolbar and viewer content ... -->
      </div>

      <div id="dialogContainer">
        <!-- ... dialog content ... -->
      </div>
    </div>

    <script>
      // Additional security: Block interactions with PDF canvas
      document.addEventListener('DOMContentLoaded', () => {
        const blockCanvasInteractions = () => {
          document.querySelectorAll('#viewer canvas').forEach(canvas => {
            canvas.addEventListener('mousedown', e => {
              if (e.button === 0) {
                e.preventDefault();
                e.stopPropagation();
              }
            }, true);
          });
        };
        
        // Initial blocking
        blockCanvasInteractions();
        
        // Continue blocking after PDF renders
        setInterval(blockCanvasInteractions, 1000);
      });
    </script>
  </body>
</html>
